---

- name: Define the scansetting
  k8s:
    apply: yes
    definition:
      apiVersion: compliance.openshift.io/v1alpha1
      kind: ScanSetting
      metadata:
        name: '{{ scan_setting }}'
        namespace: '{{ namespace }}'
      rawResultStorage:
        rotation: 3
        size: 1Gi
      roles:
      - worker
      - master
      scanTolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/master
        operator: Exists     
      schedule: '{{ cron_schedule }}'
  

- name: Check if the scansettingbinding already exists
  shell: oc get scansettingbinding -n '{{ namespace }}' | grep '{{ scan_name }}'
  register: scansettingbinding
  failed_when: scansettingbinding.rc == 2
  
- name: Delete scansettingbinding if it exists
  shell: 'oc delete scansettingbinding/{{ scan_name }}'
  when: scansettingbinding.rc == 0
  
- name: Wait for scan pods to terminate before creating a new scansettingbinding
  pause:
    minutes: 1
  when: scansettingbinding.rc == 0

- name: Create the scansettingbinding custom resource
  k8s:
    state: present
    definition:
      apiVersion: compliance.openshift.io/v1alpha1
      kind: ScanSettingBinding
      metadata:
        name: '{{ scan_name }}'
      profiles:
        - name: '{{ node_scan_profile }}'
          kind: Profile
          apiGroup: compliance.openshift.io/v1alpha1
        - name: '{{ platform_scan_profile }}'
          kind: Profile
          apiGroup: compliance.openshift.io/v1alpha1
      settingsRef:
        name: '{{ scan_setting }}'
        kind: ScanSetting
        apiGroup: compliance.openshift.io/v1alpha1
  

  

